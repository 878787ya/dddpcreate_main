<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>客製化數位心意卡片 訂購</title>
  
  <!-- Google Fonts for better typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

  <style>
    /* --- CSS 變數 --- */
    :root {
      --primary-color: #d90429; /* A strong, modern red */
      --primary-rgb: 217, 4, 41;
      --bg-color: #f7f8fc;
      --card-bg-color: #ffffff;
      --text-color: #212529;
      --muted-text-color: #6c757d;
      --border-color: #dee2e6;
      --font-heading: 'Poppins', sans-serif;
      --font-body: 'Noto Sans TC', sans-serif;
    }

    /* --- 基本設定與重置 --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.65;
      padding: 2rem 1rem;
    }

    /* --- 主容器與卡片佈局 --- */
    .container {
      max-width: 820px;
      margin: 0 auto;
      background-color: var(--card-bg-color);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    }

    /* --- 標題與排版 --- */
    .header h1 {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      position: relative;
      display: inline-block;
    }
    
    .header h1::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 50%;
      height: 4px;
      background-color: var(--primary-color);
    }

    .header .desc {
      color: var(--muted-text-color);
      margin-bottom: 2.5rem;
      font-size: 1.1rem;
    }

    section h2 {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.75rem;
    }

    /* --- 表單佈局 --- */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .field {
      margin-bottom: 1rem;
    }

    /* --- 表單元素樣式 --- */
    label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-family: var(--font-body);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input[type="file"] {
      border-style: dashed;
      background-color: var(--bg-color);
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: var(--primary-color);
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted-text-color);
      margin-top: 0.5rem;
    }

    /* --- 核取方塊樣式 --- */
    .check {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      background-color: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
    }

    .check input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
    }

    .check label {
      font-weight: normal;
      font-size: 0.9rem;
      margin-bottom: 0;
    }

    /* --- 訊息與狀態 --- */
    .error {
      margin: 1.5rem 0;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      background-color: rgba(var(--primary-rgb), 0.1);
      color: var(--primary-color);
      font-weight: bold;
    }

    /* --- 照片上傳卡片 --- */
    .upload-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      background-color: var(--card-bg-color);
    }

    /* --- 按鈕 --- */
    .button-group {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 2rem;
    }

    button {
      padding: 0.8rem 1.5rem;
      border: 0;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      font-family: var(--font-body);
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }

    button[type="submit"] {
      background-color: var(--primary-color);
      color: #fff;
    }

    button[type="submit"]:hover {
      background-color: #a7031e;
    }

    button[type="submit"]:disabled {
      background-color: #adb5bd;
      cursor: not-allowed;
    }

    button[type="reset"] {
      background-color: #e9ecef;
      color: var(--muted-text-color);
    }

    button[type="reset"]:hover {
      background-color: #ced4da;
    }
    
    .muted {
      color: #adb5bd;
      font-size: 0.8rem;
      margin-top: 1rem;
      text-align: center;
    }

    /* --- 響應式設計 --- */
    @media (max-width: 768px) {
      body { padding: 0; }
      .container { border-radius: 0; padding: 2rem 1.5rem; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>客製化數位心意卡片 訂購</h1>
      <p class="desc">填寫以下資訊後送出；我們將於 24 小時內以 Email 與你確認。</p>
    </header>

    <form id="orderForm" enctype="multipart/form-data">
      
      <section>
        <h2>1. 訂購人資訊</h2>
        <div class="grid">
          <div class="field">
            <label for="name">訂購者姓名/暱稱 *</label>
            <input id="name" name="name" required />
          </div>
          <div class="field">
            <label for="email">Email（聯絡用）*</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="field">
            <label for="phone">聯絡電話（選填）</label>
            <input id="phone" name="phone" />
          </div>
        </div>
      </section>

      <section>
        <h2>2. 卡片設計偏好</h2>
        <div class="grid">
          <div class="field">
            <label for="occasion">送禮場合 *</label>
            <select id="occasion" name="occasion" required>
              <option value="">請選擇</option>
              <option>生日</option>
              <option>畢業/師恩</option>
              <option>周年/情人節</option>
              <option>聖誕/跨年</option>
              <option>萬聖節</option>
              <option>農曆年/元宵/端午</option>
              <option>其他</option>
            </select>
          </div>
          <div class="field">
            <label for="style">喜歡的賀卡風格 *</label>
            <select id="style" name="style" required>
              <option value="">請選擇</option>
              <option>可愛風格</option><option>黑白簡約</option><option>海洋風格</option>
              <option>叢林探險</option><option>聖誕佳節</option><option>萬聖狂歡</option>
              <option>農曆新年</option><option>跨年派對</option><option>元宵佳節</option>
              <option>端午安康</option><option>感念師恩</option><option>浪漫情人</option>
            </select>
          </div>
          <div class="field">
            <label for="recipient">收禮人姓名/暱稱 *</label>
            <input id="recipient" name="recipient" required />
            <div class="hint">此名字會出現在主祝福文字中（如「親愛的 [小明]」）。</div>
          </div>
          <div class="field">
            <label for="due">希望完成日期（選填）</label>
            <input id="due" name="due_date" type="date" />
          </div>
        </div>
      </section>

      <section>
        <h2>3. 卡片內容</h2>
        <div class="field">
          <label for="main_text">主祝福文字（建議 50–100 字）*</label>
          <textarea id="main_text" name="main_text" required></textarea>
        </div>

        <div class="grid">
          <div class="field">
            <label for="photo_count">想放幾張照片？（最多 20 張）*</label>
            <select id="photo_count" name="photo_count" required></select>
            <div class="hint">選擇後會自動生成對應的上傳欄位。</div>
          </div>
          <div class="field check">
            <input id="consent_portfolio" name="consent_portfolio" type="checkbox" value="yes" />
            <label for="consent_portfolio">同意完成作品匿名截圖作為作品集（可不勾選）</label>
          </div>
        </div>

        <!-- 動態上傳區 -->
        <div id="uploads"></div>
      </section>

      <section>
        <h2>4. 其他資訊</h2>
        <div class="field">
          <label for="notes">其他備註（選填）</label>
          <textarea id="notes" name="notes" placeholder="若有任何其他想客製化的細節或問題，都可以在這裡告訴我。"></textarea>
        </div>

        <div class="field check">
          <input id="consent_terms" name="consent_terms" type="checkbox" required />
          <label for="consent_terms">我已閱讀並同意服務條款與隱私權政策 *</label>
        </div>
      </section>

      <div class="error" id="errBox"></div>
      
      <div class="button-group">
        <button type="submit" id="btn">送出訂單</button>
        <button type="reset">清除重填</button>
      </div>
      
      <p class="muted">我們僅為製作與聯繫目的使用你提供的資料。</p>
    </form>
  </div>


  <script>
    // --- 常數設定 ---
    const MAX_FILES = 20;
    const FRONT_MAX_MB = 10; // 單檔大小限制 (MB)

    // --- DOM 元素選取 ---
    const countSel = document.getElementById('photo_count');
    const uploads = document.getElementById('uploads');
    const form = document.getElementById('orderForm');
    const errBox = document.getElementById('errBox');
    const btn = document.getElementById('btn');

    // --- 初始化 ---
    // 產生 1 到 MAX_FILES 的下拉選項
    for (let i = 1; i <= MAX_FILES; i++) {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = `${i} 張`;
      countSel.appendChild(opt);
    }
    
    // 預設選項並觸發渲染
    countSel.value = '3';
    renderUploads();
    
    // --- 事件監聽 ---
    countSel.addEventListener('change', renderUploads);
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errBox.style.display = 'none';
      errBox.textContent = '';
      btn.disabled = true;
      btn.textContent = '上傳中…';

      // 前端檔案大小檢查
      const files = [...form.querySelectorAll('input[name="photos[]"]')].map(i => i.files[0]).filter(Boolean);
      for (const f of files) {
        if (f.size > FRONT_MAX_MB * 1024 * 1024) {
          showError(`檔案「${f.name}」超過 ${FRONT_MAX_MB}MB 限制。`);
          return;
        }
      }

      // 提交表單
      try {
        const fd = new FormData(form);
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: fd
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || '伺服器發生錯誤');
        }

        // 成功後跳轉
        window.location.href = '/order/thankyou.html';
      } catch (err) {
        showError(err.message || '上傳失敗，請檢查網路連線或稍後再試');
      }
    });

    // --- 輔助函式 ---
    function renderUploads() {
      uploads.innerHTML = '';
      const n = parseInt(countSel.value || '0', 10);
      for (let i = 1; i <= n; i++) {
        const card = document.createElement('div');
        card.className = 'upload-card';
        card.innerHTML = `
          <div class="field">
            <label>照片 ${i}（單檔 ≤ ${FRONT_MAX_MB}MB）*</label>
            <input type="file" name="photos" accept="image/*,.heic,.heif" required />
          </div>
          <div class="field">
            <label>照片 ${i} 的註解（選填）</label>
            <input name="captions" placeholder="想表達的話、地點或回憶點…" />
          </div>`;
        uploads.appendChild(card);
      }
    }
    
    function showError(message) {
      errBox.textContent = message;
      errBox.style.display = 'block';
      btn.disabled = false;
      btn.textContent = '送出訂單';
    }
  </script>
</body>

</html>

